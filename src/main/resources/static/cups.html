<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <script src="./assets/js/color-modes.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gerenciador de Cups</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/navbars/">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3">
    <link href="./assets/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/navbars.css" rel="stylesheet">
    <script src="./assets/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/header.js"></script>
    <style>
        input,
        select,
        th,
        td {
            text-align: center;
            /* Centraliza o conteúdo do card-body */
        }
    </style>
</head>

<body>
    <div id="header"></div> <!-- Div where the header will be inserted -->
    <div class="container mt-5">
        <h1 class="text-center mb-4">Gerenciador de Cups</h1>
        <div class="row">
            <div class="col-lg-6">
                <form id="campeonatoForm">
                    <div class="mb-3">
                        <label class="form-label">Cup</label>
                        <div id="campeonatoContainer">
                            <!-- Checkbox de campeonatos será preenchido dinamicamente -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Jogador</label>
                        <div id="usuariosContainer">
                            <!-- Checkbox de usuários será preenchido dinamicamente -->
                        </div>
                    </div>
                    <button id="submitBtn" type="submit" class="btn btn-primary">Criar Campeonato</button>
                </form>
            </div>
            <div class="col-lg-6">
                <h2 id="campeonatoSelecionado"></h2>
                <table class="table" id="tabelaClassificacao">
                    <thead>
                        <tr>
                            <th>Posição</th>
                            <th>Equipe</th>
                            <th>P</th>
                            <th>V</th>
                            <th>E</th>
                            <th>D</th>
                            <th>GM</th>
                            <th>GS</th>
                            <th>SG</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaClassificacaoBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row mt-5">
            <div class="col-lg-12">
                <h2>Tabela de Jogos</h2>
                <table class="table" id="tabelaJogos">
                    <thead>
                        <tr>
                            <th>Time Casa</th>
                            <th>Gols Casa</th>
                            <th></th>
                            <th>Gols Visitante</th>
                            <th>Time Visitante</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaJogosBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Carregar campeonatos ao carregar a página
        $(document).ready(function () {
            carregarCampeonatos();
            carregarUsuarios();
        });

        // Função para carregar os campeonatos disponíveis
        function carregarCampeonatos() {
            fetch('http://localhost:8080/api/campeonatos')
                .then(response => response.json())
                .then(data => {
                    const campeonatoContainer = document.getElementById('campeonatoContainer');
                    campeonatoContainer.innerHTML = '';
                    data.forEach(campeonato => {
                        const checkbox = `
                                <div class="form-check">
                                    <input class="form-check-input campeonato-checkbox" type="checkbox" id="campeonato-${campeonato.id}" value="${campeonato.nomeCampeonato}">
                                    <label class="form-check-label" for="campeonato-${campeonato.id}">
                                        ${campeonato.nomeCampeonato}
                                    </label>
                                </div>
                            `;
                        campeonatoContainer.insertAdjacentHTML('beforeend', checkbox);
                    });

                    // Adicionar evento para desabilitar usuários ao selecionar campeonato
                    const campeonatoCheckboxes = document.querySelectorAll('.campeonato-checkbox');
                    campeonatoCheckboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', function () {
                            if (this.checked) {
                                desabilitarCampeonatos();
                            } else {
                                habilitarCampeonatos();
                            }
                        });
                    });
                })
                .catch(error => console.error('Erro ao carregar Campeonatos:', error));
        }

        // Função para desabilitar checkboxes de usuários
        function desabilitarCampeonatos() {
            const checkboxes = document.querySelectorAll('#campeonatoContainer input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.disabled = true;
            });
        }

        // Função para habilitar checkboxes de usuários
        function habilitarCampeonatos() {
            const checkboxes = document.querySelectorAll('#campeonatoContainer input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.disabled = false;
            });
        }

        // Função para carregar os usuários disponíveis
        function carregarUsuarios() {
            fetch('http://localhost:8080/api/usuarios')
                .then(response => response.json())
                .then(data => {
                    const usuariosContainer = document.getElementById('usuariosContainer');
                    usuariosContainer.innerHTML = '';

                    data.forEach(usuario => {
                        const checkbox = `
                                <div class="form-check">
                                    <input class="form-check-input usuario-checkbox" type="checkbox" id="usuario-${usuario.id}" value="${usuario.equipe}">
                                    <label class="form-check-label" for="usuario-${usuario.id}">
                                        ${usuario.nome}
                                    </label>
                                </div>
                            `;
                        usuariosContainer.insertAdjacentHTML('beforeend', checkbox);
                    });
                })
                .catch(error => console.error('Erro ao carregar usuários:', error));
        }

        document.getElementById('campeonatoForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const campeonatoSelecionado = obterCampeonatoSelecionado();
            const usuariosSelecionados = obterUsuariosSelecionados();

            if (!campeonatoSelecionado) {
                alert('Selecione um campeonato!');
                return;
            }

            if (usuariosSelecionados.length === 0) {
                alert('Selecione pelo menos um usuário!');
                return;
            }

            // Desabilita o botão de submit após submeter o formulário
            document.getElementById('submitBtn').disabled = true;

            // Atualiza o título da página com o nome do campeonato selecionado
            document.getElementById('campeonatoSelecionado').textContent = `Tabela de Classificação - ${campeonatoSelecionado.value}`;

            // Criar o campeonato com os usuários selecionados
            criarTabelaClassificacao(campeonatoSelecionado.value, usuariosSelecionados);

            // Desabilitar checkboxes de usuários após criar o campeonato
            desabilitarUsuarios();
        });

        function desabilitarUsuarios() {
            const checkboxes = document.querySelectorAll('#usuariosContainer input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.disabled = true;
            });
        }

        // Função para obter o campeonato selecionado
        function obterCampeonatoSelecionado() {
            const checkboxes = document.querySelectorAll('#campeonatoContainer input[type="checkbox"]');
            for (let i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    return checkboxes[i];
                }
            }
            return null;
        }

        // Função para obter os usuários selecionados
        function obterUsuariosSelecionados() {
            const usuariosSelecionados = [];
            const checkboxes = document.querySelectorAll('#usuariosContainer input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    usuariosSelecionados.push({
                        equipe: checkbox.value,
                        pontos: 0, // Definir pontos inicialmente como 0
                        vitorias: 0,
                        empates: 0,
                        derrotas: 0,
                        golsMarcados: 0,
                        golsSofridos: 0,
                        saldoGols: 0
                    });
                }
            });
            return usuariosSelecionados;
        }

        // Função para criar a tabela de classificação com base nos usuários selecionados
        function criarTabelaClassificacao(campeonato, usuarios) {
            const tabelaClassificacaoBody = document.getElementById('tabelaClassificacaoBody');
            tabelaClassificacaoBody.innerHTML = '';

            // Cria cada linha da tabela de classificação com base nos dados dos usuários
            usuarios.forEach((usuario, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${usuario.equipe}</td>
                        <td>${usuario.pontos}</td>
                        <td>${usuario.vitorias}</td>
                        <td>${usuario.empates}</td>
                        <td>${usuario.derrotas}</td>
                        <td>${usuario.golsMarcados}</td>
                        <td>${usuario.golsSofridos}</td>
                        <td>${usuario.saldoGols}</td>
                    </tr>
                `;
                tabelaClassificacaoBody.insertAdjacentHTML('beforeend', row);
            });

            // Atualiza a tabela de jogos com os usuários selecionados
            atualizarTabelaJogos(usuarios);
        }

        // Função para atualizar a tabela de jogos com base nos usuários selecionados
        // Função para atualizar a tabela de jogos com base nos usuários selecionados
        function atualizarTabelaJogos(usuarios) {
            const tabelaJogosBody = document.getElementById('tabelaJogosBody');
            tabelaJogosBody.innerHTML = '';

            // Gerar jogos de ida e volta entre todos os usuários selecionados
            const jogos = gerarJogos(usuarios);

            // Embaralha os jogos
            shuffleArray(jogos);

            // Adiciona as linhas na tabela de jogos
            jogos.forEach(jogo => {
                const row = `
            <tr>
                <td>${jogo.timeCasa}</td>
                <td><input  class="form-control" type="number" id="golsCasa-${jogo.timeCasa}-${jogo.timeVisitante}" min="0" value="0"></td>
                <td>X</td>
                <td><input  class="form-control" type="number" id="golsVisitante-${jogo.timeCasa}-${jogo.timeVisitante}" min="0" value="0"></td>
                <td>${jogo.timeVisitante}</td>
                <td>
                    <button id="btn-${jogo.timeCasa}-${jogo.timeVisitante}" class="btn btn-primary" onclick="inserirResultado('${jogo.timeCasa}', '${jogo.timeVisitante}')">Inserir</button>
                </td>
            </tr>
        `;
                tabelaJogosBody.insertAdjacentHTML('beforeend', row);
            });
        }

        // Função para embaralhar um array usando o algoritmo Fisher-Yates (Knuth)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Função para gerar jogos de ida e volta entre todos os usuários selecionados
        function gerarJogos(usuarios) {
            const jogos = [];

            for (let i = 0; i < usuarios.length; i++) {
                for (let j = i + 1; j < usuarios.length; j++) {
                    // Gerar jogos de ida
                    const jogoIda = {
                        timeCasa: usuarios[i].equipe,
                        timeVisitante: usuarios[j].equipe,
                        golsCasa: 0,
                        golsVisitante: 0
                    };
                    jogos.push(jogoIda);

                    // Gerar jogos de volta
                    const jogoVolta = {
                        timeCasa: usuarios[j].equipe,
                        timeVisitante: usuarios[i].equipe,
                        golsCasa: 0,
                        golsVisitante: 0
                    };
                    jogos.push(jogoVolta);
                }
            }

            return jogos;
        }

        // Função para inserir o resultado do jogo na tabela de classificação
        function inserirResultado(timeCasa, timeVisitante) {
            // Desabilita o botão de inserir resultado após o clique
            const btnId = `btn-${timeCasa}-${timeVisitante}`;
            const btnInserir = document.getElementById(btnId);
            btnInserir.disabled = true;

            const golsCasaInput = document.getElementById(`golsCasa-${timeCasa}-${timeVisitante}`);
            const golsVisitanteInput = document.getElementById(`golsVisitante-${timeCasa}-${timeVisitante}`);

            const golsCasa = parseInt(golsCasaInput.value);
            const golsVisitante = parseInt(golsVisitanteInput.value);

            if (isNaN(golsCasa) || isNaN(golsVisitante) || golsCasa < 0 || golsVisitante < 0) {
                alert('Os gols devem ser números inteiros positivos ou zero.');
                btnInserir.disabled = false; // Habilita o botão em caso de erro
                return;
            }

            const tabelaClassificacaoBody = document.getElementById('tabelaClassificacaoBody');
            const usuarios = [];

            tabelaClassificacaoBody.querySelectorAll('tr').forEach(row => {
                const nome = row.cells[1].textContent;
                const pontos = parseInt(row.cells[2].textContent);
                const vitorias = parseInt(row.cells[3].textContent);
                const empates = parseInt(row.cells[4].textContent);
                const derrotas = parseInt(row.cells[5].textContent);
                const golsMarcados = parseInt(row.cells[6].textContent);
                const golsSofridos = parseInt(row.cells[7].textContent);
                const saldoGols = parseInt(row.cells[8].textContent);

                usuarios.push({
                    equipe: nome,
                    pontos: pontos,
                    vitorias: vitorias,
                    empates: empates,
                    derrotas: derrotas,
                    golsMarcados: golsMarcados,
                    golsSofridos: golsSofridos,
                    saldoGols: saldoGols
                });
            });

            // Atualiza os dados na tabela de classificação
            const jogoAtualizado = atualizarJogoNaTabela(timeCasa, golsCasa, timeVisitante, golsVisitante, usuarios);
            atualizarTabelaClassificacao(usuarios);

            // Verificar se houve vencedor ou empate
            if (golsCasa > golsVisitante) {
                alert(`${timeCasa} venceu o jogo contra ${timeVisitante} por ${golsCasa} a ${golsVisitante}`);
            } else if (golsVisitante > golsCasa) {
                alert(`${timeVisitante} venceu o jogo contra ${timeCasa} por ${golsVisitante} a ${golsCasa}`);
            } else {
                alert(`O jogo entre ${timeCasa} e ${timeVisitante} terminou em empate ${golsCasa} a ${golsVisitante}`);
            }

            // Após concluir o processo, você pode optar por habilitar novamente os botões se necessário
            // btnInserir.disabled = false; // Habilita o botão após o processo ser completado
        }

        // Função para atualizar os dados do jogo na tabela de classificação
        function atualizarJogoNaTabela(timeCasa, golsCasa, timeVisitante, golsVisitante, usuarios) {
            usuarios.forEach(usuario => {
                if (usuario.equipe === timeCasa) {
                    usuario.golsMarcados += golsCasa;
                    usuario.golsSofridos += golsVisitante;
                    usuario.saldoGols += (golsCasa - golsVisitante);

                    if (golsCasa > golsVisitante) {
                        usuario.pontos += 3;
                        usuario.vitorias++;
                    } else if (golsCasa === golsVisitante) {
                        usuario.pontos += 1;
                        usuario.empates++;
                    } else {
                        usuario.derrotas++;
                    }
                }

                if (usuario.equipe === timeVisitante) {
                    usuario.golsMarcados += golsVisitante;
                    usuario.golsSofridos += golsCasa;
                    usuario.saldoGols += (golsVisitante - golsCasa);

                    if (golsVisitante > golsCasa) {
                        usuario.pontos += 3;
                        usuario.vitorias++;
                    } else if (golsVisitante === golsCasa) {
                        usuario.pontos += 1;
                        usuario.empates++;
                    } else {
                        usuario.derrotas++;
                    }
                }
            });

            return usuarios;
        }

        // Função para atualizar a tabela de classificação com base nos usuários
        function atualizarTabelaClassificacao(usuarios) {
            const tabelaClassificacaoBody = document.getElementById('tabelaClassificacaoBody');
            tabelaClassificacaoBody.innerHTML = '';

            // Ordenar usuários por pontos, vitorias, saldo de gols (como critério secundário)
            usuarios.sort((a, b) => {
                if (a.pontos !== b.pontos) {
                    return b.pontos - a.pontos;
                } else if (a.vitorias !== b.vitorias) {
                    return b.vitorias - a.vitorias;
                } else {
                    return b.saldoGols - a.saldoGols;
                }
            });

            // Cria cada linha da tabela de classificação com base nos dados dos usuários
            usuarios.forEach((usuario, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${usuario.equipe}</td>
                        <td>${usuario.pontos}</td>
                        <td>${usuario.vitorias}</td>
                        <td>${usuario.empates}</td>
                        <td>${usuario.derrotas}</td>
                        <td>${usuario.golsMarcados}</td>
                        <td>${usuario.golsSofridos}</td>
                        <td>${usuario.saldoGols}</td>
                    </tr>
                `;
                tabelaClassificacaoBody.insertAdjacentHTML('beforeend', row);
            });
        }
    </script>
</body>

</html>