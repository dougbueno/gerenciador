<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <script src="./assets/js/color-modes.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Amistoso</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/navbars/">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3">
    <link href="./assets/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/navbars.css" rel="stylesheet">
    <script src="./assets/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/header.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        th,
        td {
            text-align: center;
        }

        .disabled-select {
            pointer-events: none;
            background-color: #e9ecef;
        }
    </style>
</head>

<body>
    <div id="header"></div> <!-- Div onde o cabeçalho será inserido -->
    <div class="container mt-5">
        <h1 class="mb-4">Registrar Amistoso</h1>
        <form id="amistosoForm">
            <table class="table">
                <thead>
                    <tr>
                        <th>Casa</th>
                        <th>Gols Casa</th>
                        <th>X</th>
                        <th>Gols Visitante</th>
                        <th>Visitante</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <select id="casaSelect" class="form-control"></select>
                        </td>
                        <td>
                            <input type="number" class="form-control" id="golsCasa" name="golsCasa" value="0" min="0"
                                required>
                        </td>
                        <td>X</td>
                        <td>
                            <input type="number" class="form-control" id="golsVisitante" name="golsVisitante" value="0"
                                min="0" required>
                        </td>
                        <td>
                            <select id="visitanteSelect" class="form-control"></select>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="btn btn-success" id="inserirResultadoBtn" disabled>Inserir Resultado</button>
            <button type="button" class="btn btn-danger" id="finalizarAmistosoBtn" disabled>Finalizar Amistoso</button>
        </form>
    </div>

    <div class="container mt-4">
        <h2>Resultados dos Jogos</h2>
        <table class="table" id="resultadosTable">
            <thead>
                <tr>
                    <th>Casa</th>
                    <th>Gols Casa</th>
                    <th>X</th>
                    <th>Gols Visitante</th>
                    <th>Visitante</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody>
                <!-- Conteúdo será inserido pelo JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            carregarUsuarios();
            carregarResultados();

            const casaSelect = document.getElementById('casaSelect');
            const visitanteSelect = document.getElementById('visitanteSelect');
            const inserirResultadoBtn = document.getElementById('inserirResultadoBtn');
            const finalizarAmistosoBtn = document.getElementById('finalizarAmistosoBtn');

            function carregarUsuarios() {
                fetch('http://localhost:8080/api/usuarios')
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(usuario => {
                            const casaOption = document.createElement('option');
                            casaOption.value = usuario.nome;
                            casaOption.textContent = usuario.nome;
                            casaSelect.appendChild(casaOption);

                            const visitanteOption = casaOption.cloneNode(true);
                            visitanteSelect.appendChild(visitanteOption);
                        });

                        casaSelect.addEventListener('change', validarSelecaoUsuarios);
                        visitanteSelect.addEventListener('change', validarSelecaoUsuarios);
                    })
                    .catch(error => console.error('Erro ao carregar usuários:', error));
            }

            function carregarResultados() {
                fetch('http://localhost:8080/api/jogos/amistoso')
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(resultado => {
                            adicionarResultadoNaTabela(resultado);
                        });
                    })
                    .catch(error => console.error('Erro ao carregar resultados:', error));
            }

            function validarSelecaoUsuarios() {
                const casaSelecionado = casaSelect.value;
                const visitanteSelecionado = visitanteSelect.value;

                if (casaSelecionado && visitanteSelecionado) {
                    if (casaSelecionado === visitanteSelecionado) {
                        alert('Por favor, selecione um usuário diferente para visitante.');
                        visitanteSelect.value = '';
                    }
                }

                validarInicioAmistoso();
            }

            function validarInicioAmistoso() {
                const casaSelecionado = casaSelect.value;
                const visitanteSelecionado = visitanteSelect.value;

                if (casaSelecionado && visitanteSelecionado && casaSelecionado !== visitanteSelecionado) {
                    inserirResultadoBtn.disabled = false;
                    finalizarAmistosoBtn.disabled = false
                } else {
                    inserirResultadoBtn.disabled = true;

                }
            }

            inserirResultadoBtn.addEventListener('click', function () {
                const casaSelecionado = casaSelect.value;
                const visitanteSelecionado = visitanteSelect.value;
                const golsCasa = parseInt(document.getElementById('golsCasa').value);
                const golsVisitante = parseInt(document.getElementById('golsVisitante').value);

                if (golsCasa < 0 || golsVisitante < 0) {
                    alert('Os valores dos gols não podem ser menores que 0.');
                    return;
                }

                const data = {
                    casa: casaSelecionado,
                    golsCasa: golsCasa,
                    visitante: visitanteSelecionado,
                    golsVisitante: golsVisitante,
                    campeonato: "Amistoso"
                };

                fetch('http://localhost:8080/api/jogos/amistoso', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(resultado => {
                        adicionarResultadoNaTabela(resultado);
                        casaSelect.querySelector(`option[value="${casaSelecionado}"]`).disabled = true;
                        visitanteSelect.querySelector(`option[value="${visitanteSelecionado}"]`).disabled = true;
                        finalizarAmistosoBtn.disabled = false;
                        resetInputs();
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        resetInputs();
                    });
            });

            finalizarAmistosoBtn.addEventListener('click', function () {
                adicionarEstatisticasNaTabela();
                capturarImagemTabela();
                localStorage.removeItem('amistoso');
                atualizaStatusAtivo();
                resetForm();
                setTimeout(function () {
                    location.reload();
                }, 2000); // Tempo em milissegundos
            });

            function atualizaStatusAtivo() {
                fetch('http://localhost:8080/api/jogos/amistoso/atualizar', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    if (response.status === 200) {
                        console.log('Atualização bem-sucedida');
                    } else {
                        console.error('Erro ao atualizar status:', response.status);
                    }
                })
                    .catch(error => console.error('Erro ao atualizar status:', error));
            }

            function adicionarResultadoNaTabela(resultado) {
                const resultadosTableBody = document.querySelector('#resultadosTable tbody');

                if (resultado && resultado.casa) {
                    const novaLinha = document.createElement('tr');

                    const colunaCasa = document.createElement('td');
                    colunaCasa.textContent = resultado.casa;
                    novaLinha.appendChild(colunaCasa);

                    const colunaGolsCasa = document.createElement('td');
                    colunaGolsCasa.textContent = resultado.golsCasa;
                    novaLinha.appendChild(colunaGolsCasa);

                    const colunaX = document.createElement('td');
                    colunaX.textContent = 'X';
                    novaLinha.appendChild(colunaX);

                    const colunaGolsVisitante = document.createElement('td');
                    colunaGolsVisitante.textContent = resultado.golsVisitante;
                    novaLinha.appendChild(colunaGolsVisitante);

                    const colunaVisitante = document.createElement('td');
                    colunaVisitante.textContent = resultado.visitante;
                    novaLinha.appendChild(colunaVisitante);

                    const colunaAcao = document.createElement('td');
                    const editarBtn = document.createElement('button');
                    editarBtn.className = 'btn btn-warning btn-sm me-2';
                    editarBtn.textContent = 'Editar';
                    editarBtn.addEventListener('click', function () {
                        editarResultado(resultado, novaLinha);
                    });
                    colunaAcao.appendChild(editarBtn);

                    const excluirBtn = document.createElement('button');
                    excluirBtn.className = 'btn btn-danger btn-sm';
                    excluirBtn.textContent = 'Excluir';
                    excluirBtn.addEventListener('click', function () {
                        excluirResultado(resultado, novaLinha);
                    });
                    colunaAcao.appendChild(excluirBtn);

                    novaLinha.appendChild(colunaAcao);

                    resultadosTableBody.appendChild(novaLinha);
                }
            }

            function resetInputs() {
                document.getElementById('golsCasa').value = 0;
                document.getElementById('golsVisitante').value = 0;
                validarInicioAmistoso();
            }

            function resetForm() {
                casaSelect.querySelectorAll('option').forEach(option => {
                    option.disabled = false;
                });

                visitanteSelect.querySelectorAll('option').forEach(option => {
                    option.disabled = false;
                });

                casaSelect.value = '';
                visitanteSelect.value = '';
                resetInputs();
                inserirResultadoBtn.disabled = true;
                finalizarAmistosoBtn.disabled = true;
            }

            function adicionarEstatisticasNaTabela() {
                const resultadosTableBody = document.querySelector('#resultadosTable tbody');
                const rows = resultadosTableBody.querySelectorAll('tr');

                let vitoriasCasa = 0;
                let vitoriasVisitante = 0;
                let empates = 0;
                let golsFeitosCasa = 0;
                let golsFeitosVisitante = 0;

                rows.forEach(row => {
                    const golsCasa = parseInt(row.cells[1].textContent);
                    const golsVisitante = parseInt(row.cells[3].textContent);

                    golsFeitosCasa += golsCasa;
                    golsFeitosVisitante += golsVisitante;

                    if (golsCasa > golsVisitante) {
                        vitoriasCasa++;
                    } else if (golsCasa < golsVisitante) {
                        vitoriasVisitante++;
                    } else {
                        empates++;
                    }
                });

                const totalJogos = rows.length;
                const percentualVitoriasCasa = ((vitoriasCasa / totalJogos) * 100).toFixed(2);
                const percentualVitoriasVisitante = ((vitoriasVisitante / totalJogos) * 100).toFixed(2);
                const percentualEmpates = ((empates / totalJogos) * 100).toFixed(2);

                const novaLinha = `
                    <tr>
                        <td>VIT CASA</td>
                        <td>EMP</td>
                        <td>VIT VISIT</td>
                        <td>GOLS CASA</td>
                        <td>GOLS VISITANTE</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>${vitoriasCasa} (${percentualVitoriasCasa}%)</td>
                        <td>${empates} (${percentualEmpates}%)</td>
                        <td>${vitoriasVisitante} (${percentualVitoriasVisitante}%)</td>
                        <td>${golsFeitosCasa}</td>
                        <td>${golsFeitosVisitante}</td>
                        <td></td>
                    </tr>
                `;

                resultadosTableBody.insertAdjacentHTML('beforeend', novaLinha);
            }

            function capturarImagemTabela() {
                const tabela = document.getElementById('resultadosTable');
                html2canvas(tabela).then(canvas => {
                    const imagem = canvas.toDataURL('image/png');

                    const link = document.createElement('a');
                    link.href = imagem;
                    link.download = 'resultados_amistoso.png';
                    link.click();
                });
            }

            function editarResultado(resultado, linha) {
                const golsCasaInput = document.createElement('input');
                golsCasaInput.type = 'number';
                golsCasaInput.className = 'form-control';
                golsCasaInput.value = resultado.golsCasa;

                const golsVisitanteInput = document.createElement('input');
                golsVisitanteInput.type = 'number';
                golsVisitanteInput.className = 'form-control';
                golsVisitanteInput.value = resultado.golsVisitante;

                const colunaGolsCasa = linha.children[1];
                const colunaGolsVisitante = linha.children[3];

                colunaGolsCasa.textContent = '';
                colunaGolsCasa.appendChild(golsCasaInput);
                colunaGolsVisitante.textContent = '';
                colunaGolsVisitante.appendChild(golsVisitanteInput);

                const editarBtn = linha.children[5].children[0];
                editarBtn.textContent = 'Salvar';
                editarBtn.classList.remove('btn-warning');
                editarBtn.classList.add('btn-success');

                editarBtn.removeEventListener('click', editarResultado);
                editarBtn.addEventListener('click', function () {
                    salvarEdicao(resultado, linha, golsCasaInput, golsVisitanteInput);
                });
            }

            function salvarEdicao(resultado, linha, golsCasaInput, golsVisitanteInput) {
                const golsCasa = parseInt(golsCasaInput.value);
                const golsVisitante = parseInt(golsVisitanteInput.value);

                if (golsCasa < 0 || golsVisitante < 0) {
                    alert('Os valores dos gols não podem ser menores que 0.');
                    return;
                }

                const data = {
                    golsCasa: golsCasa,
                    golsVisitante: golsVisitante
                };

                fetch(`http://localhost:8080/api/jogos/amistoso/${resultado.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => {
                        if (response.ok) {
                            linha.children[1].textContent = data.golsCasa;
                            linha.children[3].textContent = data.golsVisitante;

                            const editarBtn = linha.children[5].children[0];
                            editarBtn.textContent = 'Editar';
                            editarBtn.classList.remove('btn-success');
                            editarBtn.classList.add('btn-warning');

                            editarBtn.addEventListener('click', function () {
                                editarResultado(resultado, linha);
                            });
                        } else {
                            console.error('Erro ao salvar edição:', response.status);
                        }
                    })
                    .catch(error => console.error('Erro ao salvar edição:', error));
            }

            function excluirResultado(resultado, linha) {
                fetch(`http://localhost:8080/api/jogos/amistoso/${resultado.id}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (response.ok) {
                            linha.remove();
                        } else {
                            console.error('Erro ao excluir resultado:', response.status);
                        }
                    })
                    .catch(error => console.error('Erro ao excluir resultado:', error));
            }
        });
    </script>
</body>

</html>